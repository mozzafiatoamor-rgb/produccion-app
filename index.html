<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#1a1a2e">
<title>Mozzafiato - Control</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#0f0f1a;--surface:#1a1a2e;--surface2:#252540;--surface3:#2f2f4a;--accent:#ff6b35;--green:#34d399;--red:#f87171;--yellow:#fbbf24;--blue:#60a5fa;--text:#e8e8f0;--text2:#9898b0;--radius:14px}
html,body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);height:100%;overflow:hidden;overscroll-behavior:none;-webkit-text-size-adjust:100%}
.status-bar{display:flex;align-items:center;justify-content:space-between;padding:8px 16px 6px;background:var(--bg);position:sticky;top:0;z-index:100}
.status-left{display:flex;align-items:center;gap:10px}.app-logo{height:36px;width:auto;object-fit:contain}
.status-dot{width:8px;height:8px;border-radius:50%;background:var(--red);animation:pulse 2s infinite}.status-dot.connected{background:var(--green)}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
.status-right{display:flex;align-items:center;gap:8px}
.user-badge{display:flex;align-items:center;gap:6px;background:var(--surface2);padding:4px 10px 4px 8px;border-radius:8px;font-size:11px;color:var(--text2);cursor:pointer;border:none;font-family:'DM Sans',sans-serif}
.user-avatar{width:22px;height:22px;border-radius:6px;background:var(--accent);color:#fff;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700}
.user-name{font-weight:600;color:var(--text)}
.config-btn{background:var(--surface2);border:none;color:var(--text2);width:36px;height:36px;border-radius:10px;font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center}
.main-content{height:calc(100vh - 52px - 70px);overflow-y:scroll;padding:0 16px 80px;-webkit-overflow-scrolling:touch;touch-action:pan-y}.main-content::-webkit-scrollbar{display:none}
.card{background:var(--surface);border-radius:var(--radius);padding:20px;margin-bottom:14px;border:1px solid rgba(255,255,255,.04);animation:slideUp .4s ease}
@keyframes slideUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
.card-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
.card-title{font-size:15px;font-weight:600;color:var(--text2);text-transform:uppercase;letter-spacing:.5px;display:flex;align-items:center;gap:8px}
.stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px}
.stat-box{background:var(--surface2);border-radius:12px;padding:16px;text-align:center;position:relative;overflow:hidden}
.stat-box::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;border-radius:3px 3px 0 0}
.stat-box.orange::before{background:var(--accent)}.stat-box.green::before{background:var(--green)}.stat-box.blue::before{background:var(--blue)}.stat-box.red::before{background:var(--red)}
.stat-number{font-family:'Space Mono',monospace;font-size:28px;font-weight:700;line-height:1}
.stat-label{font-size:11px;color:var(--text2);margin-top:6px;text-transform:uppercase;letter-spacing:.5px}
.inv-item{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;background:var(--surface2);border-radius:10px;margin-bottom:8px}
.inv-name{font-size:14px;font-weight:500}.inv-cat{font-size:11px;color:var(--text2);margin-top:2px}
.inv-stock{font-family:'Space Mono',monospace;font-size:16px;font-weight:700;text-align:right}
.inv-stock.low{color:var(--red)}.inv-stock.ok{color:var(--green)}.inv-stock.warn{color:var(--yellow)}
.inv-min{font-size:10px;color:var(--text2);text-align:right;margin-top:2px}
.badge{display:inline-flex;align-items:center;gap:4px;padding:3px 8px;border-radius:6px;font-size:10px;font-weight:600;text-transform:uppercase}
.badge.critical{background:rgba(248,113,113,.15);color:var(--red)}.badge.warning{background:rgba(251,191,36,.15);color:var(--yellow)}.badge.good{background:rgba(52,211,153,.15);color:var(--green)}
.bottom-nav{position:fixed;bottom:0;left:0;right:0;background:var(--surface);border-top:1px solid rgba(255,255,255,.06);display:flex;height:70px;padding-bottom:env(safe-area-inset-bottom);z-index:100}
.nav-item{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px;border:none;background:none;color:var(--text2);font-size:9px;font-weight:500;cursor:pointer;position:relative;font-family:'DM Sans',sans-serif;padding:0 2px}
.nav-item.active{color:var(--accent)}.nav-item.active::before{content:'';position:absolute;top:0;width:32px;height:3px;background:var(--accent);border-radius:0 0 3px 3px}
.nav-icon{font-size:22px}
.form-group{margin-bottom:16px}.form-label{display:block;font-size:12px;font-weight:600;color:var(--text2);margin-bottom:6px;text-transform:uppercase;letter-spacing:.5px}
.form-input,.form-select,.form-textarea{width:100%;padding:14px 16px;background:var(--surface2);border:1px solid rgba(255,255,255,.06);border-radius:10px;color:var(--text);font-size:15px;font-family:'DM Sans',sans-serif;-webkit-appearance:none}
.form-input:focus,.form-select:focus,.form-textarea:focus{outline:none;border-color:var(--accent)}
.form-select{background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%239898b0' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 14px center;padding-right:36px}
.form-textarea{resize:none;height:80px}
.btn{width:100%;padding:16px;border:none;border-radius:12px;font-size:15px;font-weight:600;cursor:pointer;font-family:'DM Sans',sans-serif;display:flex;align-items:center;justify-content:center;gap:8px}
.btn:active{transform:scale(.97)}.btn-primary{background:var(--accent);color:#fff}.btn-primary:disabled{opacity:.4}
.btn-secondary{background:var(--surface2);color:var(--text)}.btn-success{background:var(--green);color:#0f0f1a}.btn-danger{background:var(--red);color:#fff}
.btn-sm{padding:10px 16px;font-size:13px;width:auto;border-radius:10px}
.quick-actions{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px}
.quick-btn{display:flex;flex-direction:column;align-items:center;gap:8px;padding:20px 14px;background:var(--surface2);border-radius:var(--radius);border:none;cursor:pointer;color:var(--text);font-family:'DM Sans',sans-serif}
.quick-btn:active{transform:scale(.96)}.quick-btn.disabled{opacity:.35;pointer-events:none}
.quick-icon{font-size:28px}.quick-label{font-size:13px;font-weight:600}
.cart-item{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;background:var(--surface2);border-radius:8px;margin-bottom:6px;animation:slideUp .3s ease}
.cart-item .ci-info{flex:1}.cart-item .ci-name{font-size:13px;font-weight:600}.cart-item .ci-meta{font-size:10px;color:var(--text2)}
.cart-item .ci-qty{font-family:'Space Mono',monospace;font-size:15px;font-weight:700;color:var(--accent);margin:0 12px}
.cart-item .ci-del{background:none;border:none;color:var(--red);font-size:16px;cursor:pointer;padding:4px}
.cart-item .ci-del:active{transform:scale(.8)}
.cart-header{display:flex;align-items:center;justify-content:space-between;margin:16px 0 8px}.cart-header .ch-title{font-size:12px;font-weight:600;color:var(--text2);text-transform:uppercase}.cart-header .ch-count{font-size:11px;color:var(--accent);font-weight:700}
.cart-divider{height:1px;background:rgba(255,255,255,.06);margin:16px 0}
.modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.7);backdrop-filter:blur(8px);z-index:200;display:none;align-items:flex-end;justify-content:center}
.modal-overlay.active{display:flex}
.modal{background:var(--surface);width:100%;max-width:500px;border-radius:20px 20px 0 0;padding:24px 20px 40px;max-height:90vh;overflow-y:scroll;-webkit-overflow-scrolling:touch;touch-action:pan-y;animation:slideModal .3s ease}
@keyframes slideModal{from{transform:translateY(100%)}to{transform:translateY(0)}}
.modal-handle{width:40px;height:4px;background:var(--surface3);border-radius:4px;margin:0 auto 20px}
.modal-title{font-size:20px;font-weight:700;margin-bottom:20px;display:flex;align-items:center;gap:10px}
.toast{position:fixed;top:20px;left:50%;transform:translateX(-50%) translateY(-100px);background:var(--green);color:#0f0f1a;padding:12px 24px;border-radius:12px;font-weight:600;font-size:14px;z-index:300;transition:transform .4s cubic-bezier(.34,1.56,.64,1);display:flex;align-items:center;gap:8px;white-space:nowrap;max-width:90vw}
.toast.error{background:var(--red);color:#fff}.toast.show{transform:translateX(-50%) translateY(0)}
.setup-screen{height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:30px;text-align:center}
.setup-logo{height:60px;width:auto;margin-bottom:20px;object-fit:contain}
.setup-title{font-size:24px;font-weight:700;margin-bottom:10px}
.setup-desc{font-size:14px;color:var(--text2);margin-bottom:30px;line-height:1.6;max-width:320px}
.setup-input,.login-input{width:100%;max-width:360px;padding:16px;background:var(--surface);border:2px solid var(--surface3);border-radius:12px;color:var(--text);font-size:16px;font-family:'DM Sans',sans-serif;text-align:center;margin-bottom:12px}
.setup-input{font-family:'Space Mono',monospace;font-size:14px}
.setup-input:focus,.login-input:focus{outline:none;border-color:var(--accent)}
.setup-input::placeholder,.login-input::placeholder{color:var(--text2);font-family:'DM Sans',sans-serif}
.step-indicator{display:flex;gap:8px;margin-bottom:20px}.step-dot{width:8px;height:8px;border-radius:50%;background:var(--surface3)}.step-dot.active{background:var(--accent);width:24px;border-radius:4px}
.help-box{background:var(--surface);border-radius:12px;padding:16px;text-align:left;margin-bottom:20px;max-width:360px;width:100%;border:1px solid rgba(255,255,255,.06)}
.help-box h4{font-size:13px;color:var(--accent);margin-bottom:8px}.help-box ol{padding-left:20px;font-size:12px;color:var(--text2);line-height:2}
.search-bar{display:flex;align-items:center;gap:10px;background:var(--surface2);border-radius:10px;padding:0 14px;margin-bottom:14px}
.search-bar input{flex:1;padding:12px 0;background:none;border:none;color:var(--text);font-size:14px;font-family:'DM Sans',sans-serif}
.search-bar input:focus{outline:none}.search-bar input::placeholder{color:var(--text2)}
.report-row{display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid rgba(255,255,255,.04)}.report-row:last-child{border:none}
.tab-pills{display:flex;gap:8px;margin-bottom:16px;overflow-x:auto}.tab-pills::-webkit-scrollbar{display:none}
.tab-pill{padding:8px 16px;border-radius:8px;border:none;background:var(--surface2);color:var(--text2);font-size:12px;font-weight:600;font-family:'DM Sans',sans-serif;white-space:nowrap;cursor:pointer}
.tab-pill.active{background:var(--accent);color:#fff}
.empty-state{text-align:center;padding:40px 20px;color:var(--text2)}.empty-state .empty-icon{font-size:48px;margin-bottom:12px}
.record-item{background:var(--surface2);border-radius:10px;padding:14px;margin-bottom:8px}
.record-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
.record-product{font-size:14px;font-weight:600}
.record-qty{font-family:'Space Mono',monospace;font-size:16px;font-weight:700;color:var(--accent)}
.record-meta{font-size:11px;color:var(--text2);display:flex;gap:12px;flex-wrap:wrap}
.dup-warning{background:rgba(251,191,36,.1);border:1px solid rgba(251,191,36,.3);border-radius:8px;padding:10px 14px;margin-top:8px;font-size:12px;color:var(--yellow);display:flex;align-items:center;gap:8px}
.uib{background:var(--surface2);border-radius:10px;padding:10px 14px;margin-bottom:14px;display:flex;align-items:center;gap:10px;font-size:13px}
.uib-av{width:32px;height:32px;border-radius:8px;background:var(--accent);color:#fff;display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:700}
.uib-name{font-weight:600}.uib-role{font-size:11px;color:var(--text2)}
</style>
</head>
<body>
<div class="toast" id="toast"></div>
<div id="app"></div>
<script>
const LOGO='logo.png',SCRIPT_URL='https://script.google.com/macros/s/AKfycbw6udHOPKq_A20Y53NCL1tnEgpl7_FNCqdP0ycjB7HQs6sltZttFPlpW_SrZd7FH6pZ/exec';
const S={screen:'setup',setupStep:1,tab:'home',sheetId:localStorage.getItem('sheetId')||'',apiKey:localStorage.getItem('apiKey')||'',connected:false,currentUser:null,usuarios:[],catalogo:[],produccion:[],ventas:[],mermas:[],recetas:[],inventario:[],stockBajo:[],bitacora:[],loading:false,searchQuery:'',reportTab:'ventas',filterDate:'',viewMode:'resumen',ventasView:'normal'};
const Sheets={
  async read(sh,rg){const r=await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${S.sheetId}/values/${encodeURIComponent(sh)}!${rg}?key=${S.apiKey}`);if(!r.ok)throw new Error(r.status);const d=await r.json();return d.values||[]},
  async append(sh,v){const r=await fetch(SCRIPT_URL,{method:'POST',body:JSON.stringify({sheet:sh,values:v})});const d=await r.json();if(!d.success)throw new Error(d.error);return d},
  async loadUsers(){try{const rows=await this.read('\u{1F464} Usuarios','A2:E50');S.usuarios=rows.map(r=>({id:r[0]||'',usuario:r[1]||'',password:r[2]||'',nombre:r[3]||'',rol:(r[4]||'usuario').toLowerCase()})).filter(u=>u.usuario);return true}catch(e){console.error(e);return false}},
  async loadAll(){S.loading=true;render();try{
    const c=await this.read('\u{1F4E6} Cat\u00e1logo','A2:F100');S.catalogo=c.map(r=>({id:r[0]||'',categoria:r[1]||'',producto:r[2]||'',stockMinimo:parseInt(r[3])||0,unidad:r[4]||'',activo:(r[5]||'SI').toString().trim().toUpperCase()})).filter(p=>p.producto&&p.activo!=='NO');
    const iv=await this.read('\u{1F4CA} Inventario','A2:G100');S.inventario=iv.map(r=>({categoria:r[0]||'',producto:r[1]||'',stockActual:parseInt(r[2])||0,totalProducido:parseInt(r[3])||0,totalVendido:parseInt(r[4])||0,stockMinimo:parseInt(r[5])||0,estado:r[6]||''})).filter(p=>p.producto);
    const sb=await this.read('\u{1F6A8} Stock Bajo','A2:E100');S.stockBajo=sb.map(r=>({categoria:r[0]||'',producto:r[1]||'',stockActual:parseInt(r[2])||0,stockMinimo:parseInt(r[3])||0,faltante:parseInt(r[4])||0})).filter(p=>p.producto);
    const pr=await this.read('\u{1F3ED} Producci\u00f3n','A2:I1000');S.produccion=pr.map(r=>({id:r[0]||'',fecha:normDate(r[1]),dia:r[2]||'',turno:r[3]||'',categoria:r[4]||'',producto:r[5]||'',cantidad:parseInt(r[6])||0,responsable:r[7]||'',notas:r[8]||''})).filter(p=>p.producto).reverse();
    const vt=await this.read('\u{1F4B0} Ventas','A2:G1000');S.ventas=vt.map(r=>({id:r[0]||'',fecha:normDate(r[1]),categoria:r[2]||'',producto:r[3]||'',cantidad:parseInt(r[4])||0,vendedor:r[5]||'',notas:r[6]||''})).filter(p=>p.producto).reverse();
    try{const rc=await this.read('\u{1F37D}\ufe0f Recetas','A2:E500');S.recetas=rc.map(r=>({platillo:r[0]||'',categoria:r[1]||'',ingrediente:r[2]||'',cantidad:parseFloat(r[3])||0,unidad:r[4]||''})).filter(r=>r.platillo&&r.ingrediente)}catch(e){S.recetas=[]}
    try{const mr=await this.read('\u{26a0}\ufe0f Mermas','A2:H1000');S.mermas=mr.map(r=>({id:r[0]||'',fecha:normDate(r[1]),hora:r[2]||'',categoria:r[3]||'',producto:r[4]||'',cantidad:parseInt(r[5])||0,motivo:r[6]||'',responsable:r[7]||''})).filter(p=>p.producto).reverse()}catch(e){S.mermas=[]}
    S.connected=true}catch(e){console.error(e);toast('Error al cargar',1);S.connected=false}
    try{const bt=await this.read('\u{1F4DC} Bit\u00e1cora','A2:F500');S.bitacora=bt.map(r=>({fecha:normDate(r[0]),hora:r[1]||'',usuario:r[2]||'',accion:r[3]||'',detalle:r[4]||'',tipo:r[5]||''})).filter(b=>b.accion).reverse().slice(0,200)}catch(e){S.bitacora=[]}
    S.loading=false;render()}
};
function toast(m,e){const t=document.getElementById('toast');t.textContent=(e?'\u26a0\ufe0f ':'\u2705 ')+m;t.className='toast show'+(e?' error':'');setTimeout(()=>t.className='toast',2500)}
function today(){return new Date().toLocaleDateString('es-MX',{year:'numeric',month:'2-digit',day:'2-digit'})}
function now(){const d=new Date();return{date:d.toLocaleDateString('es-MX',{year:'numeric',month:'2-digit',day:'2-digit'}),time:d.toLocaleTimeString('es-MX',{hour:'2-digit',minute:'2-digit',second:'2-digit'})}}
function dateToISO(d){if(!d)return'';if(d.includes('-'))return d;const p=d.split('/');if(p.length!==3)return d;return p[2]+'-'+p[1].padStart(2,'0')+'-'+p[0].padStart(2,'0')}
function isoToDate(d){if(!d)return'';const p=d.split('-');if(p.length!==3)return d;return p[2]+'/'+p[1]+'/'+p[0]}
function normDate(d){if(!d)return'';const s=String(d).trim();if(s.includes('-')){const p=s.split('-');return p[2].padStart(2,'0')+'/'+p[1].padStart(2,'0')+'/'+p[0]}if(s.includes('/')){const p=s.split('/');return p[0].padStart(2,'0')+'/'+p[1].padStart(2,'0')+'/'+p[2]}return s}
async function logAction(a,d,t){const n=now();try{await Sheets.append('\u{1F4DC} Bit\u00e1cora',[n.date,n.time,uName(),a,d,t])}catch(e){}}
function dayName(){return new Date().toLocaleDateString('es-MX',{weekday:'long'})}
function nextId(p,l){const n=l.map(r=>parseInt((r.id||'0').replace(/\D/g,''))||0);return p+String((n.length?Math.max(...n):0)+1).padStart(4,'0')}
function getCats(){return[...new Set(S.catalogo.map(p=>p.categoria))].filter(Boolean).sort()}
function getProds(c){return c?S.catalogo.filter(p=>p.categoria===c):S.catalogo}
function isDup(n,c){return S.catalogo.some(p=>p.producto.trim().toLowerCase()===n.trim().toLowerCase()&&p.categoria.trim().toLowerCase()===c.trim().toLowerCase())}
function isAdmin(){return S.currentUser&&S.currentUser.rol==='admin'}
function uName(){return S.currentUser?S.currentUser.nombre:''}
function uInit(){if(!S.currentUser)return'?';return S.currentUser.nombre.split(' ').map(p=>p[0]).join('').toUpperCase().slice(0,2)}

function render(){const a=document.getElementById('app');if(S.screen==='setup')a.innerHTML=renderSetup();else if(S.screen==='login')a.innerHTML=renderLogin();else a.innerHTML=renderMain()}

function renderSetup(){
  if(S.setupStep===1)return`<div class="setup-screen"><div class="step-indicator"><div class="step-dot active"></div><div class="step-dot"></div></div><img src="${LOGO}" class="setup-logo" onerror="this.style.display='none'"><div class="setup-title">Conectar Google Sheet</div><div class="setup-desc">Pega el ID de tu hoja de Google Sheets</div><div class="help-box"><h4>\u{1F4CB} \u00bfD\u00f3nde encuentro el ID?</h4><ol><li>Abre tu Google Sheet</li><li>Copia la URL</li><li>El ID est\u00e1 entre /d/ y /edit</li></ol></div><input class="setup-input" id="si" placeholder="ID de tu Google Sheet" value="${S.sheetId}" oninput="S.sheetId=this.value.trim();document.getElementById('btnN1').disabled=!S.sheetId" onpaste="setTimeout(()=>{S.sheetId=document.getElementById('si').value.trim();document.getElementById('btnN1').disabled=!S.sheetId},100)" onchange="S.sheetId=this.value.trim();document.getElementById('btnN1').disabled=!S.sheetId"><div style="width:100%;max-width:360px"><button class="btn btn-primary" id="btnN1" onclick="S.setupStep=2;render()" ${!S.sheetId?'disabled':''}>Siguiente \u2192</button></div></div>`;
  return`<div class="setup-screen"><div class="step-indicator"><div class="step-dot"></div><div class="step-dot active"></div></div><img src="${LOGO}" class="setup-logo" onerror="this.style.display='none'"><div class="setup-title">API Key de Google</div><div class="setup-desc">Pega tu clave de API de Google Cloud.</div><div class="help-box"><h4>\u{1F4CB} C\u00f3mo obtener tu API Key</h4><ol><li>Ve a console.cloud.google.com</li><li>APIs y servicios \u2192 Credenciales</li><li>Crear credenciales \u2192 Clave de API</li></ol></div><input class="setup-input" id="ak" placeholder="Tu API Key" type="password" value="${S.apiKey}" oninput="S.apiKey=this.value.trim();document.getElementById('btnC').disabled=!S.apiKey" onpaste="setTimeout(()=>{S.apiKey=document.getElementById('ak').value.trim();document.getElementById('btnC').disabled=!S.apiKey},100)" onchange="S.apiKey=this.value.trim();document.getElementById('btnC').disabled=!S.apiKey"><div style="width:100%;max-width:360px;display:flex;flex-direction:column;gap:10px"><button class="btn btn-primary" id="btnC" onclick="connectSheet()" ${!S.apiKey?'disabled':''}>\u{1F50C} Conectar</button><button class="btn btn-secondary" onclick="S.setupStep=1;render()">\u2190 Atr\u00e1s</button></div></div>`}

async function connectSheet(){if(!S.sheetId||!S.apiKey)return;toast('Conectando...');try{await Sheets.read('\u{1F4E6} Cat\u00e1logo','A1:A2');localStorage.setItem('sheetId',S.sheetId);localStorage.setItem('apiKey',S.apiKey);await Sheets.loadUsers();S.screen='login';S.connected=true;toast('\u00a1Conectado! Inicia sesi\u00f3n');render()}catch(e){toast('Error: Verifica ID y API Key',1)}}

function renderLogin(){return`<div class="setup-screen"><img src="${LOGO}" class="setup-logo" onerror="this.style.display='none'"><div class="setup-title">Iniciar Sesi\u00f3n</div><div class="setup-desc">Ingresa tus credenciales</div><input class="login-input" id="lu" placeholder="\u{1F464} Usuario" autocapitalize="off" autocomplete="off"><input class="login-input" id="lp" placeholder="\u{1F512} Contrase\u00f1a" type="password" onkeydown="if(event.key==='Enter')doLogin()"><div style="width:100%;max-width:360px"><button class="btn btn-primary" onclick="doLogin()">\u{1F511} Entrar</button></div><div style="margin-top:20px;font-size:11px;color:var(--text2)">Solicita tus credenciales al administrador</div></div>`}

async function doLogin(){const u=document.getElementById('lu').value.trim().toLowerCase(),p=document.getElementById('lp').value;if(!u||!p){toast('Escribe usuario y contrase\u00f1a',1);return}await Sheets.loadUsers();const f=S.usuarios.find(x=>x.usuario.toLowerCase()===u&&x.password===p);if(!f){toast('Usuario o contrase\u00f1a incorrectos',1);return}S.currentUser={id:f.id,usuario:f.usuario,nombre:f.nombre,rol:f.rol};localStorage.setItem('currentUser',JSON.stringify(S.currentUser));S.screen='main';toast('\u00a1Bienvenido, '+f.nombre+'!');await Sheets.loadAll()}

function logout(){S.currentUser=null;localStorage.removeItem('currentUser');S.screen='login';modalType=null;render();toast('Sesi\u00f3n cerrada')}

function renderMain(){const sc=S.connected?'connected':'';let c='';switch(S.tab){case'home':c=renderHome();break;case'produccion':c=renderProd();break;case'ventas':c=renderVent();break;case'mermas':c=renderMermas();break;case'inventario':c=renderInv();break;case'bitacora':c=renderBit();break}
return`<div class="status-bar"><div class="status-left"><div class="status-dot ${sc}"></div><img src="${LOGO}" class="app-logo" onerror="this.textContent='\u{1F35D}'"></div><div class="status-right"><button class="user-badge" onclick="openModal('userMenu')"><div class="user-avatar">${uInit()}</div><span class="user-name">${uName()}</span></button><button class="config-btn" onclick="openModal('settings')">\u2699\ufe0f</button></div></div><div class="main-content" id="mc">${S.loading?'<div class="empty-state"><div class="empty-icon">\u23f3</div><p>Cargando...</p></div>':c}</div><nav class="bottom-nav"><button class="nav-item ${S.tab==='home'?'active':''}" onclick="switchTab('home')"><span class="nav-icon">\u{1F3E0}</span>Inicio</button><button class="nav-item ${S.tab==='produccion'?'active':''}" onclick="switchTab('produccion')"><span class="nav-icon">\u{1F3ED}</span>Producci\u00f3n</button><button class="nav-item ${S.tab==='ventas'?'active':''}" onclick="switchTab('ventas')"><span class="nav-icon">\u{1F4B0}</span>Ventas</button><button class="nav-item ${S.tab==='mermas'?'active':''}" onclick="switchTab('mermas')"><span class="nav-icon">\u26a0\ufe0f</span>Mermas</button><button class="nav-item ${S.tab==='inventario'?'active':''}" onclick="switchTab('inventario')"><span class="nav-icon">\u{1F4E6}</span>Inventario</button><button class="nav-item ${S.tab==='bitacora'?'active':''}" onclick="switchTab('bitacora')"><span class="nav-icon">\u{1F4DC}</span>Bit\u00e1cora</button></nav>${renderModal()}`}

function switchTab(t){S.tab=t;S.searchQuery='';S.filterDate='';render()}

function filterResults(){const l=document.getElementById('resultsList');if(!l)return;const q=S.searchQuery.toLowerCase();
if(S.tab==='produccion'){let d=S.produccion;if(S.filterDate)d=d.filter(p=>p.fecha===S.filterDate);const f=q?d.filter(p=>p.producto.toLowerCase().includes(q)||p.categoria.toLowerCase().includes(q)||p.responsable.toLowerCase().includes(q)):d;l.innerHTML=S.viewMode==='resumen'?renderSummary(groupBy(f,function(p){return p.producto}),'\u{1F3ED}'):renderProdList(f)}
else if(S.tab==='ventas'){let d=S.ventas;if(S.filterDate)d=d.filter(p=>p.fecha===S.filterDate);const f=q?d.filter(p=>p.producto.toLowerCase().includes(q)||p.categoria.toLowerCase().includes(q)||p.vendedor.toLowerCase().includes(q)):d;l.innerHTML=S.viewMode==='resumen'?renderSummary(groupBy(f,function(p){return p.producto}),'\u{1F4B0}'):renderVentList(f)}
else if(S.tab==='mermas'){let d=S.mermas;if(S.filterDate)d=d.filter(p=>p.fecha===S.filterDate);if(q)d=d.filter(p=>p.producto.toLowerCase().includes(q)||p.motivo.toLowerCase().includes(q)||p.responsable.toLowerCase().includes(q));l.innerHTML=renderMermasList(d)}
else if(S.tab==='inventario'){const f=q?S.inventario.filter(p=>p.producto.toLowerCase().includes(q)||p.categoria.toLowerCase().includes(q)):S.inventario;l.innerHTML=f.length===0?'<div class="empty-state"><div class="empty-icon">\u{1F4E6}</div><p>No hay datos</p></div>':f.map(p=>{const pc=p.stockMinimo>0?(p.stockActual/p.stockMinimo):999;const cl=pc<1?'low':pc<1.5?'warn':'ok';const bg=pc<1?'<span class="badge critical">BAJO</span>':pc<1.5?'<span class="badge warning">MEDIO</span>':'<span class="badge good">OK</span>';return`<div class="inv-item"><div style="flex:1"><div style="display:flex;align-items:center;gap:8px"><div class="inv-name">${p.producto}</div>${bg}</div><div class="inv-cat">${p.categoria} \u00b7 Prod: ${p.totalProducido} \u00b7 Vend: ${p.totalVendido}</div></div><div><div class="inv-stock ${cl}">${p.stockActual}</div><div class="inv-min">M\u00edn: ${p.stockMinimo}</div></div></div>`}).join('')}
else if(S.tab==='bitacora'){let d=S.bitacora;if(S.filterDate)d=d.filter(b=>b.fecha===S.filterDate);if(q)d=d.filter(b=>b.accion.toLowerCase().includes(q)||b.detalle.toLowerCase().includes(q)||b.usuario.toLowerCase().includes(q));l.innerHTML=renderBitList(d)}}

function renderHome(){const tp=S.produccion.filter(p=>p.fecha===today()).reduce((s,p)=>s+p.cantidad,0),tv=S.ventas.filter(p=>p.fecha===today()).reduce((s,p)=>s+p.cantidad,0),tm=S.mermas.filter(m=>m.fecha===today()).reduce((s,m)=>s+m.cantidad,0),ls=S.stockBajo.length,tc=S.catalogo.length;
return`<div class="uib"><div class="uib-av">${uInit()}</div><div><div class="uib-name">Hola, ${uName()} \u{1F44B}</div><div class="uib-role">${isAdmin()?'\u{1F511} Administrador':'\u{1F464} Usuario'}</div></div></div><div class="stats-grid"><div class="stat-box orange"><div class="stat-number">${tc}</div><div class="stat-label">Productos</div></div><div class="stat-box red"><div class="stat-number">${ls}</div><div class="stat-label">Stock Bajo</div></div><div class="stat-box green"><div class="stat-number">${tp}</div><div class="stat-label">Producido Hoy</div></div><div class="stat-box blue"><div class="stat-number">${tv}</div><div class="stat-label">Vendido Hoy</div></div>${tm>0?'<div class="stat-box" style="background:rgba(248,113,113,.15)"><div class="stat-number" style="color:var(--red)">'+tm+'</div><div class="stat-label">Merma Hoy</div></div>':''}</div><div class="quick-actions"><button class="quick-btn" onclick="openModal('produccion')"><span class="quick-icon">\u{1F3ED}</span><span class="quick-label">Registrar Producci\u00f3n</span></button><button class="quick-btn" onclick="openModal('venta')"><span class="quick-icon">\u{1F4B0}</span><span class="quick-label">Registrar Venta</span></button><button class="quick-btn" onclick="S.ventasView='tpv';switchTab('ventas')"><span class="quick-icon">\u{1F37D}\ufe0f</span><span class="quick-label">Venta TPV</span></button><button class="quick-btn" onclick="openModal('merma')"><span class="quick-icon">\u26a0\ufe0f</span><span class="quick-label">Registrar Merma</span></button><button class="quick-btn ${isAdmin()?'':'disabled'}" onclick="${isAdmin()?"openModal('addProduct')":""}"><span class="quick-icon">\u2795</span><span class="quick-label">Nuevo Producto</span>${!isAdmin()?'<span style="font-size:10px;color:var(--red)">\u{1F512} Admin</span>':''}</button><button class="quick-btn" onclick="Sheets.loadAll()"><span class="quick-icon">\u{1F504}</span><span class="quick-label">Actualizar</span></button></div>${ls>0?`<div class="card"><div class="card-header"><span class="card-title">\u{1F6A8} Necesitan Producci\u00f3n</span><span class="badge critical">${ls}</span></div>${S.stockBajo.map(p=>`<div class="inv-item"><div><div class="inv-name">${p.producto}</div><div class="inv-cat">${p.categoria}</div></div><div><div class="inv-stock low">${p.stockActual}</div><div class="inv-min">M\u00edn: ${p.stockMinimo} (Faltan: ${p.faltante})</div></div></div>`).join('')}</div>`:''}${S.produccion.length>0?`<div class="card"><div class="card-header"><span class="card-title">\u{1F3ED} \u00daltima Producci\u00f3n</span></div>${S.produccion.slice(0,3).map(p=>`<div class="record-item"><div class="record-top"><span class="record-product">${p.producto}</span><span class="record-qty">${p.cantidad}</span></div><div class="record-meta"><span>\u{1F4C5} ${p.fecha}</span><span>\u{1F464} ${p.responsable}</span>${p.turno?`<span>\u{1F550} ${p.turno}</span>`:''}</div></div>`).join('')}</div>`:''}`}

function groupBy(arr,keyFn){const g={};arr.forEach(function(item){const k=keyFn(item);if(!g[k])g[k]={items:[],total:0};g[k].items.push(item);g[k].total+=item.cantidad});return g}
function renderSummary(grouped,icon){const keys=Object.keys(grouped).sort(function(a,b){return grouped[b].total-grouped[a].total});if(!keys.length)return'<div class="empty-state"><div class="empty-icon">'+icon+'</div><p>No hay registros</p></div>';const totalAll=keys.reduce(function(s,k){return s+grouped[k].total},0);return'<div style="background:var(--surface2);border-radius:10px;padding:12px 14px;margin-bottom:12px;display:flex;justify-content:space-between;align-items:center"><span style="font-size:13px;color:var(--text2)">'+keys.length+' productos</span><span style="font-family:Space Mono;font-weight:700;font-size:18px;color:var(--accent)">'+totalAll+' total</span></div>'+keys.map(function(k){var g=grouped[k];var item=g.items[0];var pct=totalAll>0?Math.round(g.total/totalAll*100):0;var byUser={};g.items.forEach(function(it){var u=it.responsable||it.vendedor||'';if(!u)return;if(!byUser[u])byUser[u]=0;byUser[u]+=it.cantidad});var userList=Object.entries(byUser).sort(function(a,b){return b[1]-a[1]});return'<div class="record-item"><div class="record-top"><span class="record-product">'+k+'</span><span class="record-qty" style="font-size:18px">'+g.total+'</span></div><div style="background:var(--surface3);border-radius:4px;height:4px;margin:6px 0;overflow:hidden"><div style="background:var(--accent);height:100%;width:'+pct+'%;border-radius:4px"></div></div><div class="record-meta"><span>\u{1F4C1} '+(item.categoria||item.cat||'')+'</span><span>'+g.items.length+' registros</span><span>'+pct+'%</span></div>'+userList.map(function(u){return'<div style="display:flex;justify-content:space-between;align-items:center;padding:4px 8px;margin-top:4px;background:var(--surface2);border-radius:6px;font-size:12px"><span style="color:var(--text2)">\u{1F464} '+u[0]+'</span><span style="font-family:Space Mono;font-weight:600;color:var(--accent)">'+u[1]+'</span></div>'}).join('')+'</div>'}).join('')}
function renderProd(){let d=S.produccion;if(S.filterDate)d=d.filter(p=>p.fecha===S.filterDate);const q=S.searchQuery.toLowerCase(),f=q?d.filter(p=>p.producto.toLowerCase().includes(q)||p.categoria.toLowerCase().includes(q)||p.responsable.toLowerCase().includes(q)):d;const grouped=groupBy(f,function(p){return p.producto});return`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px"><span class="card-title" style="margin:0">\u{1F3ED} Producci\u00f3n</span><button class="btn btn-primary btn-sm" onclick="openModal('produccion')">+ Registrar</button></div><div style="display:flex;gap:8px;margin-bottom:10px"><div class="tab-pills" style="flex:1;margin:0"><button class="tab-pill ${S.filterDate===''?'active':''}" onclick="S.filterDate='';render()">Todas</button><button class="tab-pill ${S.filterDate===today()?'active':''}" onclick="S.filterDate=today();render()">Hoy</button></div><input type="date" class="form-input" style="width:140px;padding:7px 10px;font-size:12px" value="${S.filterDate?dateToISO(S.filterDate):''}" onchange="S.filterDate=this.value?isoToDate(this.value):'';render()"></div><div class="tab-pills" style="margin-bottom:10px"><button class="tab-pill ${S.viewMode==='resumen'?'active':''}" onclick="S.viewMode='resumen';render()">\u{1F4CA} Resumen</button><button class="tab-pill ${S.viewMode==='detalle'?'active':''}" onclick="S.viewMode='detalle';render()">\u{1F4DD} Detalle</button></div><div class="search-bar"><span>\u{1F50D}</span><input placeholder="Buscar..." value="${S.searchQuery}" oninput="S.searchQuery=this.value;filterResults()"></div><div id="resultsList">${S.viewMode==='resumen'?renderSummary(grouped,'\u{1F3ED}'):renderProdList(f)}</div>`}
function renderProdList(f){return f.length===0?'<div class="empty-state"><div class="empty-icon">\u{1F3ED}</div><p>No hay registros</p></div>':f.map(p=>`<div class="record-item"><div class="record-top"><span class="record-product">${p.producto}</span><span class="record-qty">${p.cantidad}</span></div><div class="record-meta"><span>\u{1F4C5} ${p.fecha}</span><span>\u{1F4C1} ${p.categoria}</span><span>\u{1F464} ${p.responsable}</span>${p.turno?`<span>\u{1F550} ${p.turno}</span>`:''}</div>${p.notas?`<div style="font-size:11px;color:var(--text2);margin-top:6px">\u{1F4DD} ${p.notas}</div>`:''}</div>`).join('')}

function renderVent(){var vv=S.ventasView||'normal';let d=S.ventas;if(S.filterDate)d=d.filter(p=>p.fecha===S.filterDate);const q=S.searchQuery.toLowerCase(),f=q?d.filter(p=>p.producto.toLowerCase().includes(q)||p.categoria.toLowerCase().includes(q)||p.vendedor.toLowerCase().includes(q)):d;const grouped=groupBy(f,function(p){return p.producto});return`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px"><span class="card-title" style="margin:0">\u{1F4B0} Ventas</span>${vv==='normal'?'<button class="btn btn-primary btn-sm" onclick="openModal(\'venta\')">+ Registrar</button>':''}</div><div class="tab-pills" style="margin-bottom:10px"><button class="tab-pill ${vv==='normal'?'active':''}" onclick="S.ventasView='normal';render()">\u{1F4B0} Normal</button><button class="tab-pill ${vv==='tpv'?'active':''}" onclick="S.ventasView='tpv';render()">\u{1F37D}\ufe0f TPV</button><button class="tab-pill ${vv==='recetas'?'active':''}" onclick="S.ventasView='recetas';render()">\u{1F4D6} Recetas</button></div>`+(vv==='normal'?renderVentNormal(f,grouped):vv==='tpv'?renderVentTPV():renderVentRecetas())}
function renderVentNormal(f,grouped){return`<div style="display:flex;gap:8px;margin-bottom:10px"><div class="tab-pills" style="flex:1;margin:0"><button class="tab-pill ${S.filterDate===''?'active':''}" onclick="S.filterDate='';render()">Todas</button><button class="tab-pill ${S.filterDate===today()?'active':''}" onclick="S.filterDate=today();render()">Hoy</button></div><input type="date" class="form-input" style="width:140px;padding:7px 10px;font-size:12px" value="${S.filterDate?dateToISO(S.filterDate):''}" onchange="S.filterDate=this.value?isoToDate(this.value):'';render()"></div><div class="tab-pills" style="margin-bottom:10px"><button class="tab-pill ${S.viewMode==='resumen'?'active':''}" onclick="S.viewMode='resumen';render()">\u{1F4CA} Resumen</button><button class="tab-pill ${S.viewMode==='detalle'?'active':''}" onclick="S.viewMode='detalle';render()">\u{1F4DD} Detalle</button></div><div class="search-bar"><span>\u{1F50D}</span><input placeholder="Buscar..." value="${S.searchQuery}" oninput="S.searchQuery=this.value;filterResults()"></div><div id="resultsList">${S.viewMode==='resumen'?renderSummary(grouped,'\u{1F4B0}'):renderVentList(f)}</div>`}
function renderVentList(f){return f.length===0?'<div class="empty-state"><div class="empty-icon">\u{1F4B0}</div><p>No hay registros</p></div>':f.map(p=>`<div class="record-item"><div class="record-top"><span class="record-product">${p.producto}</span><span class="record-qty">${p.cantidad}</span></div><div class="record-meta"><span>\u{1F4C5} ${p.fecha}</span><span>\u{1F4C1} ${p.categoria}</span><span>\u{1F464} ${p.vendedor}</span></div>${p.notas?`<div style="font-size:11px;color:var(--text2);margin-top:6px">\u{1F4DD} ${p.notas}</div>`:''}</div>`).join('')}

function renderMermas(){let d=S.mermas;if(S.filterDate)d=d.filter(p=>p.fecha===S.filterDate);const q=S.searchQuery.toLowerCase(),f=q?d.filter(p=>p.producto.toLowerCase().includes(q)||p.motivo.toLowerCase().includes(q)||p.responsable.toLowerCase().includes(q)):d;const totalHoy=S.mermas.filter(m=>m.fecha===today()).reduce((s,m)=>s+m.cantidad,0);return`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px"><span class="card-title" style="margin:0">\u26a0\ufe0f Mermas</span><button class="btn btn-primary btn-sm" onclick="openModal('merma')">+ Registrar</button></div>${totalHoy>0?'<div style="background:rgba(248,113,113,.1);border:1px solid rgba(248,113,113,.3);border-radius:10px;padding:10px 14px;margin-bottom:12px;font-size:13px;color:var(--red)">\u26a0\ufe0f Mermas hoy: <strong>'+totalHoy+' unidades</strong></div>':''}<div style="display:flex;gap:8px;margin-bottom:10px"><div class="tab-pills" style="flex:1;margin:0"><button class="tab-pill ${S.filterDate===''?'active':''}" onclick="S.filterDate='';render()">Todas</button><button class="tab-pill ${S.filterDate===today()?'active':''}" onclick="S.filterDate=today();render()">Hoy</button></div><input type="date" class="form-input" style="width:140px;padding:7px 10px;font-size:12px" value="${S.filterDate?dateToISO(S.filterDate):''}" onchange="S.filterDate=this.value?isoToDate(this.value):'';render()"></div><div class="search-bar"><span>\u{1F50D}</span><input placeholder="Buscar producto, motivo..." value="${S.searchQuery}" oninput="S.searchQuery=this.value;filterResults()"></div><div id="resultsList">${renderMermasList(f)}</div>`}
function renderMermasList(f){return!f.length?'<div class="empty-state"><div class="empty-icon">\u26a0\ufe0f</div><p>Sin mermas registradas</p></div>':f.map(p=>'<div class="record-item" style="border-left:3px solid var(--red);padding-left:12px"><div class="record-top"><span class="record-product">'+p.producto+'</span><span class="record-qty" style="color:var(--red)">-'+p.cantidad+'</span></div><div style="font-size:12px;margin:4px 0;color:var(--yellow)">\u{1F4DD} '+p.motivo+'</div><div class="record-meta"><span>\u{1F4C5} '+p.fecha+'</span><span>\u{1F552} '+p.hora+'</span><span>\u{1F4C1} '+p.categoria+'</span><span>\u{1F464} '+p.responsable+'</span></div></div>').join('')}

function renderInv(){const q=S.searchQuery.toLowerCase(),f=q?S.inventario.filter(p=>p.producto.toLowerCase().includes(q)||p.categoria.toLowerCase().includes(q)):S.inventario;return`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px"><span class="card-title" style="margin:0">\u{1F4E6} Inventario</span>${isAdmin()?'<button class="btn btn-primary btn-sm" onclick="openModal(\'addProduct\')">+ Producto</button>':''}</div><div class="search-bar"><span>\u{1F50D}</span><input placeholder="Buscar..." value="${S.searchQuery}" oninput="S.searchQuery=this.value;filterResults()"></div><div id="resultsList">${f.length===0?'<div class="empty-state"><div class="empty-icon">\u{1F4E6}</div><p>No hay datos</p></div>':f.map(p=>{const pc=p.stockMinimo>0?(p.stockActual/p.stockMinimo):999;const cl=pc<1?'low':pc<1.5?'warn':'ok';const bg=pc<1?'<span class="badge critical">BAJO</span>':pc<1.5?'<span class="badge warning">MEDIO</span>':'<span class="badge good">OK</span>';return`<div class="inv-item"><div style="flex:1"><div style="display:flex;align-items:center;gap:8px"><div class="inv-name">${p.producto}</div>${bg}</div><div class="inv-cat">${p.categoria} \u00b7 Prod: ${p.totalProducido} \u00b7 Vend: ${p.totalVendido}</div></div><div><div class="inv-stock ${cl}">${p.stockActual}</div><div class="inv-min">M\u00edn: ${p.stockMinimo}</div></div></div>`}).join('')}</div>`}

function renderBit(){let d=S.bitacora;if(S.filterDate)d=d.filter(b=>b.fecha===S.filterDate);const q=S.searchQuery.toLowerCase();if(q)d=d.filter(b=>b.accion.toLowerCase().includes(q)||b.detalle.toLowerCase().includes(q)||b.usuario.toLowerCase().includes(q));return`<div style="margin-bottom:14px"><span class="card-title" style="margin:0">\u{1F4DC} Bit\u00e1cora</span></div><div style="display:flex;gap:8px;margin-bottom:10px"><div class="tab-pills" style="flex:1;margin:0"><button class="tab-pill ${S.filterDate===''?'active':''}" onclick="S.filterDate='';render()">Todas</button><button class="tab-pill ${S.filterDate===today()?'active':''}" onclick="S.filterDate=today();render()">Hoy</button></div><input type="date" class="form-input" style="width:140px;padding:7px 10px;font-size:12px" value="${S.filterDate?dateToISO(S.filterDate):''}" onchange="S.filterDate=this.value?isoToDate(this.value):'';render()"></div><div class="search-bar"><span>\u{1F50D}</span><input placeholder="Buscar usuario, acci\u00f3n..." value="${S.searchQuery}" oninput="S.searchQuery=this.value;filterResults()"></div><div id="resultsList">${renderBitList(d)}</div>`}
function renderBitList(f){return!f.length?'<div class="empty-state"><div class="empty-icon">\u{1F4DC}</div><p>Sin registros</p></div>':f.map(b=>`<div class="record-item"><div style="font-size:13px;font-weight:600">${b.accion}</div><div style="font-size:12px;margin:4px 0">${b.detalle}</div><div class="record-meta"><span>\u{1F4C5} ${b.fecha}</span><span>\u{1F552} ${b.hora}</span><span>\u{1F464} ${b.usuario}</span><span class="badge info">${b.tipo}</span></div></div>`).join('')}

function renderRep(){return`<div class="card-title" style="margin-bottom:14px">\u{1F4CA} Reportes</div><div class="tab-pills"><button class="tab-pill ${S.reportTab==='ventas'?'active':''}" onclick="S.reportTab='ventas';render()">Ventas</button><button class="tab-pill ${S.reportTab==='produccion'?'active':''}" onclick="S.reportTab='produccion';render()">Producci\u00f3n</button><button class="tab-pill ${S.reportTab==='resumen'?'active':''}" onclick="S.reportTab='resumen';render()">Resumen</button></div>${S.reportTab==='ventas'?repV():S.reportTab==='produccion'?repP():repR()}`}
function repV(){if(!S.ventas.length)return'<div class="empty-state"><div class="empty-icon">\u{1F4B0}</div><p>Sin datos</p></div>';const b={};S.ventas.forEach(v=>{if(!b[v.producto])b[v.producto]={c:0,n:0};b[v.producto].c+=v.cantidad;b[v.producto].n++});return`<div class="card"><div class="card-header"><span class="card-title">Top Vendidos</span></div>${Object.entries(b).sort((a,c)=>c[1].c-a[1].c).map(([p,d],i)=>`<div class="report-row"><div><div style="font-size:14px;font-weight:500">${i+1}. ${p}</div><div style="font-size:11px;color:var(--text2)">${d.n} transacciones</div></div><div style="font-family:'Space Mono';font-weight:700;color:var(--blue)">${d.c}</div></div>`).join('')}</div>`}
function repP(){if(!S.produccion.length)return'<div class="empty-state"><div class="empty-icon">\u{1F3ED}</div><p>Sin datos</p></div>';const b={};S.produccion.forEach(p=>{if(!b[p.producto])b[p.producto]={c:0,n:0};b[p.producto].c+=p.cantidad;b[p.producto].n++});return`<div class="card"><div class="card-header"><span class="card-title">Top Producci\u00f3n</span></div>${Object.entries(b).sort((a,c)=>c[1].c-a[1].c).map(([p,d],i)=>`<div class="report-row"><div><div style="font-size:14px;font-weight:500">${i+1}. ${p}</div><div style="font-size:11px;color:var(--text2)">${d.n} lotes</div></div><div style="font-family:'Space Mono';font-weight:700;color:var(--green)">${d.c}</div></div>`).join('')}</div>`}
function repR(){const tp=S.produccion.reduce((s,p)=>s+p.cantidad,0),tv=S.ventas.reduce((s,p)=>s+p.cantidad,0);return`<div class="stats-grid"><div class="stat-box green"><div class="stat-number">${tp}</div><div class="stat-label">Total Producido</div></div><div class="stat-box blue"><div class="stat-number">${tv}</div><div class="stat-label">Total Vendido</div></div><div class="stat-box orange"><div class="stat-number">${S.catalogo.length}</div><div class="stat-label">Productos</div></div><div class="stat-box red"><div class="stat-number">${S.stockBajo.length}</div><div class="stat-label">Stock Bajo</div></div></div><div class="card"><div class="card-header"><span class="card-title">Estado General</span></div><div class="report-row"><span>Registros producci\u00f3n</span><strong>${S.produccion.length}</strong></div><div class="report-row"><span>Registros ventas</span><strong>${S.ventas.length}</strong></div><div class="report-row"><span>Stock bajo</span><strong style="color:var(--red)">${S.stockBajo.length}</strong></div></div>`}

let modalType=null;
function renderModal(){if(!modalType)return'<div class="modal-overlay" id="modal"></div>';let c='';if(modalType==='produccion')c=fmProd();if(modalType==='venta')c=fmVenta();if(modalType==='merma')c=fmMerma();if(modalType==='addProduct')c=fmAddProd();if(modalType==='receta')c=fmReceta();if(modalType==='editReceta')c=fmEditReceta();if(modalType==='settings')c=fmSettings();if(modalType==='userMenu')c=fmUser();return`<div class="modal-overlay active" id="modal" onclick="if(event.target===this)closeModal()"><div class="modal"><div class="modal-handle"></div>${c}</div></div>`}
function openModal(t){if(t==='addProduct'&&!isAdmin()){toast('Solo admin puede agregar productos',1);return}modalType=t;render()}
function closeModal(){modalType=null;render()}

function fmUser(){return`<div class="modal-title">\u{1F464} Mi Cuenta</div><div style="text-align:center;margin-bottom:20px"><div style="width:60px;height:60px;border-radius:16px;background:var(--accent);color:#fff;display:flex;align-items:center;justify-content:center;font-size:24px;font-weight:700;margin:0 auto 12px">${uInit()}</div><div style="font-size:18px;font-weight:700">${uName()}</div><div style="font-size:13px;color:var(--text2);margin-top:4px">@${S.currentUser?.usuario||''}</div><span class="badge ${isAdmin()?'role-admin':'role-user'}" style="margin-top:8px;display:inline-flex">${isAdmin()?'\u{1F511} Administrador':'\u{1F464} Usuario'}</span></div><button class="btn btn-danger" onclick="logout()">\u{1F6AA} Cerrar Sesi\u00f3n</button><div style="height:10px"></div><button class="btn btn-secondary" onclick="closeModal()">Cancelar</button>`}

function fmProd(){const cats=getCats();return`<div class="modal-title">\u{1F3ED} Registrar Producci\u00f3n</div><div style="background:var(--surface2);border-radius:8px;padding:10px 14px;margin-bottom:16px;font-size:13px;display:flex;align-items:center;gap:8px"><span>\u{1F464}</span><strong>${uName()}</strong><span style="color:var(--text2)">como responsable</span></div><div class="form-group"><label class="form-label">Categor\u00eda</label><select class="form-select" id="fPC" onchange="updSel('fPP',this.value)"><option value="">Seleccionar...</option>${cats.map(c=>`<option value="${c}">${c}</option>`).join('')}</select></div><div class="form-group"><label class="form-label">Producto</label><select class="form-select" id="fPP"><option value="">Primero selecciona categor\u00eda</option></select></div><div class="form-group"><label class="form-label">Cantidad</label><input class="form-input" id="fPQ" type="number" inputmode="numeric" placeholder="0" min="1"></div><div class="form-group"><label class="form-label">Turno</label><select class="form-select" id="fPT"><option value="Ma\u00f1ana">Ma\u00f1ana</option><option value="Tarde">Tarde</option><option value="Noche">Noche</option></select></div><div class="form-group"><label class="form-label">Notas (opcional)</label><textarea class="form-textarea" id="fPN" placeholder="Observaciones..."></textarea></div><button class="btn btn-secondary" onclick="addToCartProd()">\u2795 Agregar a lista</button><div id="cartProd">${renderCartProd()}</div><div class="cart-divider"></div><button class="btn btn-primary" onclick="submitCartProd()" ${_cartProd.length===0?'disabled':''}>\u2705 Guardar Todo (${_cartProd.length})</button><div style="height:10px"></div><button class="btn btn-secondary" onclick="clearCartProd();closeModal()">\u2716 Cerrar</button>`}

function fmVenta(){const cats=getCats();return`<div class="modal-title">\u{1F4B0} Registrar Venta</div><div style="background:var(--surface2);border-radius:8px;padding:10px 14px;margin-bottom:16px;font-size:13px;display:flex;align-items:center;gap:8px"><span>\u{1F464}</span><strong>${uName()}</strong><span style="color:var(--text2)">como vendedor</span></div><div class="form-group"><label class="form-label">Categor\u00eda</label><select class="form-select" id="fVC" onchange="updSel('fVP',this.value);showStock()"><option value="">Seleccionar...</option>${cats.map(c=>`<option value="${c}">${c}</option>`).join('')}</select></div><div class="form-group"><label class="form-label">Producto</label><select class="form-select" id="fVP" onchange="showStock()"><option value="">Primero selecciona categor\u00eda</option></select></div><div id="stockInfo"></div><div class="form-group"><label class="form-label">Cantidad</label><input class="form-input" id="fVQ" type="number" inputmode="numeric" placeholder="0" min="1"></div><div class="form-group"><label class="form-label">Notas (opcional)</label><textarea class="form-textarea" id="fVN" placeholder="Observaciones..."></textarea></div><button class="btn btn-secondary" onclick="addToCartVenta()">\u2795 Agregar a lista</button><div id="cartVenta">${renderCartVenta()}</div><div class="cart-divider"></div><button class="btn btn-primary" onclick="submitCartVenta()" ${_cartVenta.length===0?'disabled':''}>\u2705 Guardar Todo (${_cartVenta.length})</button><div style="height:10px"></div><button class="btn btn-secondary" onclick="clearCartVenta();closeModal()">\u2716 Cerrar</button>`}

function fmAddProd(){if(!isAdmin())return'<div class="modal-title">\u{1F512} Acceso denegado</div><p style="color:var(--text2)">Solo admin.</p><button class="btn btn-secondary" onclick="closeModal()">Cerrar</button>';const cats=getCats();return`<div class="modal-title">\u2795 Nuevo Producto</div><div class="form-group"><label class="form-label">Categor\u00eda</label><select class="form-select" id="fNPC"><option value="">Seleccionar...</option>${cats.map(c=>`<option value="${c}">${c}</option>`).join('')}<option value="__new__">\uff0b Crear nueva categor\u00eda...</option></select></div><div id="newCatField" style="display:none"><div class="form-group"><label class="form-label">Nueva Categor\u00eda</label><input class="form-input" id="fNCN" placeholder="Nombre"></div></div><div class="form-group"><label class="form-label">Nombre del Producto</label><input class="form-input" id="fNPN" placeholder="Ej: Ravioles de ricotta" oninput="chkDup()"></div><div id="dupW"></div><div class="form-group"><label class="form-label">Stock M\u00ednimo</label><input class="form-input" id="fNPM" type="number" inputmode="numeric" placeholder="0" min="0"></div><div class="form-group"><label class="form-label">Unidad</label><select class="form-select" id="fNPU"><option value="Porciones">Porciones</option><option value="Unidades">Unidades</option><option value="Kilos">Kilos</option><option value="Litros">Litros</option><option value="Bandejas">Bandejas</option><option value="Paquetes">Paquetes</option></select></div><button class="btn btn-success" onclick="subNewProd()">\u2705 Agregar</button><div style="height:10px"></div><button class="btn btn-secondary" onclick="closeModal()">\u2716 Cerrar</button>`}

function fmSettings(){return`<div class="modal-title">\u2699\ufe0f Configuraci\u00f3n</div><div style="text-align:center;margin-bottom:20px"><img src="${LOGO}" style="height:40px;opacity:.7" onerror="this.style.display='none'"></div><div class="form-group"><label class="form-label">Sheet ID</label><input class="form-input" value="${S.sheetId}" id="sS" style="font-family:'Space Mono';font-size:12px"></div><div class="form-group"><label class="form-label">API Key</label><input class="form-input" value="${S.apiKey}" id="sA" type="password" style="font-family:'Space Mono';font-size:12px"></div><button class="btn btn-primary" onclick="saveSett()">\u{1F4BE} Guardar</button><div style="height:10px"></div><button class="btn btn-secondary" onclick="resetApp()" style="color:var(--red)">\u{1F5D1}\ufe0f Desconectar</button><div style="height:10px"></div><button class="btn btn-secondary" onclick="closeModal()">Cerrar</button>`}

function updSel(id,cat){const s=document.getElementById(id);const p=getProds(cat);s.innerHTML=p.length?p.map(x=>`<option value="${x.producto}">${x.producto}</option>`).join(''):'<option value="">Sin productos</option>'}

function showStock(){const i=document.getElementById('stockInfo');if(!i)return;const p=document.getElementById('fVP')?.value;if(!p){i.innerHTML='';return}const inv=S.inventario.find(x=>x.producto.trim().toLowerCase()===p.trim().toLowerCase());const st=inv?inv.stockActual:0;if(st<=0)i.innerHTML='<div style="background:rgba(248,113,113,.15);border:1px solid rgba(248,113,113,.3);border-radius:8px;padding:10px 14px;margin-bottom:12px;font-size:13px;color:var(--red)">\u{1F6AB} <strong>Stock: 0</strong> \u2014 No se puede vender</div>';else if(inv&&st<=inv.stockMinimo)i.innerHTML=`<div style="background:rgba(251,191,36,.1);border:1px solid rgba(251,191,36,.3);border-radius:8px;padding:10px 14px;margin-bottom:12px;font-size:13px;color:var(--yellow)">\u26a0\ufe0f <strong>Stock: ${st}</strong> \u2014 Bajo</div>`;else i.innerHTML=`<div style="background:rgba(52,211,153,.1);border:1px solid rgba(52,211,153,.3);border-radius:8px;padding:10px 14px;margin-bottom:12px;font-size:13px;color:var(--green)">\u2705 <strong>Stock: ${st}</strong></div>`}

document.addEventListener('change',function(e){if(e.target.id==='fNPC'){const f=document.getElementById('newCatField');if(f)f.style.display=e.target.value==='__new__'?'block':'none'}});

function chkDup(){const n=document.getElementById('fNPN')?.value||'';const w=document.getElementById('dupW');if(!w)return;if(n.length<2){w.innerHTML='';return}const s=S.catalogo.filter(p=>p.producto.toLowerCase().includes(n.toLowerCase()));if(s.length>0)w.innerHTML=`<div class="dup-warning">\u26a0\ufe0f Similares: ${s.map(p=>`<strong>${p.producto}</strong> (${p.categoria})`).join(', ')}</div>`;else w.innerHTML=''}

let _cartProd=[],_cartVenta=[],_cartMerma=[];
function addToCartProd(){const cat=document.getElementById('fPC').value,prod=document.getElementById('fPP').value,qty=document.getElementById('fPQ').value,turno=document.getElementById('fPT').value,notas=document.getElementById('fPN').value;if(!cat||!prod||!qty||parseInt(qty)<1){toast('Completa los campos',1);return}
_cartProd.push({cat,prod,qty:parseInt(qty),turno,notas});toast(prod+' x'+qty+' agregado');document.getElementById('fPP').selectedIndex=0;document.getElementById('fPQ').value='';document.getElementById('fPN').value='';document.getElementById('cartProd').innerHTML=renderCartProd();document.querySelector('#modal .btn-primary').disabled=false;document.querySelector('#modal .btn-primary').innerHTML='\u2705 Guardar Todo ('+_cartProd.length+')'}
function removeCartProd(i){_cartProd.splice(i,1);document.getElementById('cartProd').innerHTML=renderCartProd();const btn=document.querySelector('#modal .btn-primary');btn.disabled=_cartProd.length===0;btn.innerHTML='\u2705 Guardar Todo ('+_cartProd.length+')'}
function renderCartProd(){if(_cartProd.length===0)return'';return'<div class="cart-header"><span class="ch-title">\u{1F4CB} Lista</span><span class="ch-count">'+_cartProd.length+' items</span></div>'+_cartProd.map((c,i)=>'<div class="cart-item"><div class="ci-info"><div class="ci-name">'+c.prod+'</div><div class="ci-meta">'+c.cat+' \u00b7 '+c.turno+(c.notas?' \u00b7 '+c.notas:'')+'</div></div><span class="ci-qty">'+c.qty+'</span><button class="ci-del" onclick="removeCartProd('+i+')">\u2716</button></div>').join('')}
function clearCartProd(){_cartProd=[]}
async function submitCartProd(){if(_cartProd.length===0)return;const total=_cartProd.length;const detalle=_cartProd.map(c=>c.qty+' '+c.prod).join(', ');let ok=0;for(const c of _cartProd){const id=nextId('P',S.produccion);try{await Sheets.append('\u{1F3ED} Producci\u00f3n',[id,today(),dayName(),c.turno,c.cat,c.prod,c.qty,uName(),c.notas]);ok++}catch(e){toast('Error en '+c.prod,1)}}
_cartProd=[];await logAction('Producci\u00f3n',detalle,'produccion');toast(ok+'/'+total+' registros guardados');closeModal();Sheets.loadAll()}
function addToCartVenta(){const cat=document.getElementById('fVC').value,prod=document.getElementById('fVP').value,qty=document.getElementById('fVQ').value,notas=document.getElementById('fVN').value;if(!cat||!prod||!qty||parseInt(qty)<1){toast('Completa los campos',1);return}
const inv=S.inventario.find(p=>p.producto.trim().toLowerCase()===prod.trim().toLowerCase());const st=inv?inv.stockActual:0;const cv=parseInt(qty);const already=_cartVenta.filter(c=>c.prod.trim().toLowerCase()===prod.trim().toLowerCase()).reduce((s,c)=>s+c.qty,0);
if(st<=0){toast('\u274c '+prod+' stock en 0',1);return}if(cv+already>st){toast('\u274c Solo hay '+st+' de '+prod+(already>0?', ya tienes '+already+' en lista':''),1);return}
_cartVenta.push({cat,prod,qty:cv,notas,stock:st});toast(prod+' x'+qty+' agregado');document.getElementById('fVP').selectedIndex=0;document.getElementById('fVQ').value='';document.getElementById('fVN').value='';document.getElementById('stockInfo').innerHTML='';document.getElementById('cartVenta').innerHTML=renderCartVenta();document.querySelector('#modal .btn-primary').disabled=false;document.querySelector('#modal .btn-primary').innerHTML='\u2705 Guardar Todo ('+_cartVenta.length+')'}
function removeCartVenta(i){_cartVenta.splice(i,1);document.getElementById('cartVenta').innerHTML=renderCartVenta();const btn=document.querySelector('#modal .btn-primary');btn.disabled=_cartVenta.length===0;btn.innerHTML='\u2705 Guardar Todo ('+_cartVenta.length+')'}
function renderCartVenta(){if(_cartVenta.length===0)return'';return'<div class="cart-header"><span class="ch-title">\u{1F6D2} Lista de Venta</span><span class="ch-count">'+_cartVenta.length+' items</span></div>'+_cartVenta.map((c,i)=>'<div class="cart-item"><div class="ci-info"><div class="ci-name">'+c.prod+'</div><div class="ci-meta">'+c.cat+(c.notas?' \u00b7 '+c.notas:'')+'</div></div><span class="ci-qty">'+c.qty+'</span><button class="ci-del" onclick="removeCartVenta('+i+')">\u2716</button></div>').join('')}
function clearCartVenta(){_cartVenta=[]}

function fmMerma(){const cats=getCats();return'<div class="modal-title">\u26a0\ufe0f Registrar Merma</div><div style="background:rgba(248,113,113,.1);border:1px solid rgba(248,113,113,.3);border-radius:8px;padding:10px 14px;margin-bottom:16px;font-size:13px;color:var(--red)">\u{1F464} <strong>'+uName()+'</strong> \u2014 Baja de inventario por merma</div><div class="form-group"><label class="form-label">Categor\u00eda</label><select class="form-select" id="fMC" onchange="updSel(\'fMP\',this.value);showStockMerma()"><option value="">Seleccionar...</option>'+cats.map(function(c){return'<option value="'+c+'">'+c+'</option>'}).join('')+'</select></div><div class="form-group"><label class="form-label">Producto</label><select class="form-select" id="fMP" onchange="showStockMerma()"><option value="">Primero selecciona categor\u00eda</option></select></div><div id="stockInfoMerma"></div><div class="form-group"><label class="form-label">Cantidad a dar de baja</label><input class="form-input" id="fMQ" type="number" inputmode="numeric" placeholder="0" min="1"></div><div class="form-group"><label class="form-label">Motivo de la merma</label><select class="form-select" id="fMM"><option value="Caducidad">Caducidad / Vencimiento</option><option value="Da\u00f1o">Da\u00f1o / Maltrato</option><option value="Sobreproducci\u00f3n">Sobreproducci\u00f3n</option><option value="Devoluci\u00f3n">Devoluci\u00f3n cliente</option><option value="Error producci\u00f3n">Error en producci\u00f3n</option><option value="Contaminaci\u00f3n">Contaminaci\u00f3n</option><option value="Otro">Otro</option></select></div><div class="form-group"><label class="form-label">Detalle / Observaciones</label><textarea class="form-textarea" id="fMN" placeholder="Describe el motivo con m\u00e1s detalle..."></textarea></div><button class="btn btn-secondary" onclick="addToCartMerma()">\u2795 Agregar a lista</button><div id="cartMerma">'+renderCartMerma()+'</div><div class="cart-divider"></div><button class="btn btn-primary" style="background:var(--red)" onclick="submitCartMerma()" '+(_cartMerma.length===0?'disabled':'')+' id="btnSaveMerma">\u26a0\ufe0f Registrar Merma ('+_cartMerma.length+')</button><div style="height:10px"></div><button class="btn btn-secondary" onclick="clearCartMerma();closeModal()">\u2716 Cerrar</button>'}
function showStockMerma(){var p=document.getElementById('fMP')?.value;var el=document.getElementById('stockInfoMerma');if(!el)return;if(!p){el.innerHTML='';return}var inv=S.inventario.find(function(x){return x.producto.trim().toLowerCase()===p.trim().toLowerCase()});if(inv){el.innerHTML='<div style="background:var(--surface2);border-radius:8px;padding:10px 14px;margin-bottom:12px;font-size:13px">\u{1F4E6} Stock actual: <strong style="color:var(--accent)">'+inv.stockActual+'</strong></div>'}else{el.innerHTML='<div style="background:var(--surface2);border-radius:8px;padding:10px 14px;margin-bottom:12px;font-size:13px;color:var(--text2)">Sin inventario</div>'}}
function addToCartMerma(){var cat=document.getElementById('fMC').value,prod=document.getElementById('fMP').value,qty=document.getElementById('fMQ').value,motivo=document.getElementById('fMM').value,notas=document.getElementById('fMN').value;if(!cat||!prod||!qty||parseInt(qty)<1){toast('Completa los campos',1);return}var inv=S.inventario.find(function(x){return x.producto.trim().toLowerCase()===prod.trim().toLowerCase()});var st=inv?inv.stockActual:0;var already=_cartMerma.filter(function(c){return c.prod.trim().toLowerCase()===prod.trim().toLowerCase()}).reduce(function(s,c){return s+c.qty},0);if(parseInt(qty)+already>st){toast('\u274c Solo hay '+st+' de '+prod+(already>0?', ya tienes '+already+' en lista':''),1);return}_cartMerma.push({cat:cat,prod:prod,qty:parseInt(qty),motivo:motivo,notas:notas});toast(prod+' x'+qty+' agregado');document.getElementById('fMP').selectedIndex=0;document.getElementById('fMQ').value='';document.getElementById('fMN').value='';document.getElementById('stockInfoMerma').innerHTML='';document.getElementById('cartMerma').innerHTML=renderCartMerma();var btn=document.getElementById('btnSaveMerma');if(btn){btn.disabled=false;btn.innerHTML='\u26a0\ufe0f Registrar Merma ('+_cartMerma.length+')'}}
function removeCartMerma(i){_cartMerma.splice(i,1);document.getElementById('cartMerma').innerHTML=renderCartMerma();var btn=document.getElementById('btnSaveMerma');if(btn){btn.disabled=_cartMerma.length===0;btn.innerHTML='\u26a0\ufe0f Registrar Merma ('+_cartMerma.length+')'}}
function renderCartMerma(){if(!_cartMerma.length)return'';return'<div class="cart-header"><span class="ch-title" style="color:var(--red)">\u26a0\ufe0f Mermas</span><span class="ch-count">'+_cartMerma.length+' items</span></div>'+_cartMerma.map(function(c,i){return'<div class="cart-item" style="border-left:3px solid var(--red)"><div class="ci-info"><div class="ci-name">'+c.prod+'</div><div class="ci-meta">'+c.motivo+(c.notas?' \u00b7 '+c.notas:'')+'</div></div><span class="ci-qty" style="color:var(--red)">-'+c.qty+'</span><button class="ci-del" onclick="removeCartMerma('+i+')">\u2716</button></div>'}).join('')}
function clearCartMerma(){_cartMerma=[]}
async function submitCartMerma(){if(!_cartMerma.length)return;var total=_cartMerma.length;var detalle=_cartMerma.map(function(c){return c.qty+' '+c.prod+' ('+c.motivo+')'}).join(', ');var n=now();var ok=0;for(var c of _cartMerma){var id=nextId('M',S.mermas);try{await Sheets.append('\u26a0\ufe0f Mermas',[id,n.date,n.time,c.cat,c.prod,c.qty,c.motivo+(c.notas?' - '+c.notas:''),uName()]);ok++}catch(e){toast('Error en '+c.prod,1)}}_cartMerma=[];await logAction('Merma',detalle,'merma');toast(ok+'/'+total+' mermas registradas');closeModal();Sheets.loadAll()}
// === TPV ===
var _tpvCart={};
function getPlatillos(){var platillos={};S.recetas.forEach(function(r){if(!platillos[r.platillo])platillos[r.platillo]={nombre:r.platillo,categoria:r.categoria,ingredientes:[]};platillos[r.platillo].ingredientes.push({producto:r.ingrediente,cantidad:r.cantidad,unidad:r.unidad})});return platillos}
function renderVentTPV(){var platillos=getPlatillos();var keys=Object.keys(platillos).sort();var q=S.searchQuery.toLowerCase();if(q)keys=keys.filter(function(k){return k.toLowerCase().includes(q)||platillos[k].categoria.toLowerCase().includes(q)});var cats=[...new Set(keys.map(function(k){return platillos[k].categoria}))].sort();var catF=S.catFilterTPV||'todos';if(catF!=='todos')keys=keys.filter(function(k){return platillos[k].categoria===catF});var totalItems=Object.values(_tpvCart).reduce(function(s,v){return s+v},0);
if(!keys.length&&!S.recetas.length)return'<div class="empty-state"><div class="empty-icon">\u{1F37D}\ufe0f</div><p>Sin recetas configuradas</p><p style="font-size:12px;color:var(--text2);margin-top:8px">'+(isAdmin()?'Ve a la pesta\u00f1a Recetas para agregar platillos':'Pide al admin que configure las recetas')+'</p></div>';
return'<div style="background:rgba(59,130,246,.1);border:1px solid rgba(59,130,246,.3);border-radius:10px;padding:10px 14px;margin-bottom:12px;font-size:13px;color:var(--accent)">\u{1F37D}\ufe0f Selecciona platillos vendidos y registra. Se descontar\u00e1 autom\u00e1ticamente de producci\u00f3n.</div><div class="tab-pills" style="margin-bottom:8px"><button class="tab-pill '+(catF==='todos'?'active':'')+'" onclick="S.catFilterTPV=\'todos\';render()">Todos</button>'+cats.map(function(c){return'<button class="tab-pill '+(catF===c?'active':'')+'" onclick="S.catFilterTPV=\''+c.replace(/'/g,"\\'")+'\';render()">'+c+'</button>'}).join('')+'</div><div class="search-bar"><span>\u{1F50D}</span><input placeholder="Buscar platillo..." value="'+S.searchQuery+'" oninput="S.searchQuery=this.value;render()"></div>'+keys.map(function(k){var p=platillos[k];var qty=_tpvCart[k]||0;return'<div style="background:'+(qty>0?'rgba(52,211,153,.08)':'var(--surface2)')+';border-radius:12px;padding:12px;margin-bottom:8px;transition:all .2s"><div style="display:flex;align-items:center;gap:10px"><div style="flex:1"><div style="font-size:14px;font-weight:700">'+k+'</div><div style="font-size:11px;color:var(--text2)">'+p.categoria+' \u00b7 '+p.ingredientes.map(function(i){return i.cantidad+' '+i.producto}).join(', ')+'</div></div><div style="display:flex;align-items:center;gap:6px"><button onclick="tpvQty(\''+k.replace(/'/g,"\\'")+'\',-1)" style="width:32px;height:32px;border-radius:8px;border:1px solid var(--surface3);background:var(--surface);color:var(--text);font-size:18px;cursor:pointer">\u2212</button><span style="font-family:Space Mono;font-weight:700;font-size:16px;min-width:24px;text-align:center;color:'+(qty>0?'var(--green)':'var(--text2)')+'">'+qty+'</span><button onclick="tpvQty(\''+k.replace(/'/g,"\\'")+'\',1)" style="width:32px;height:32px;border-radius:8px;border:1px solid var(--accent);background:var(--accent);color:#fff;font-size:18px;cursor:pointer">+</button></div></div></div>'}).join('')+(totalItems>0?'<div style="position:sticky;bottom:80px;z-index:50;padding:0 4px"><button class="btn btn-success" onclick="submitTPV()" style="width:100%;padding:14px;font-size:15px;border-radius:14px;box-shadow:0 4px 20px rgba(52,211,153,.4)">\u{1F37D}\ufe0f Registrar '+totalItems+' Platillo'+(totalItems>1?'s':'')+' Vendidos</button></div>':'')}
function tpvQty(platillo,delta){if(!_tpvCart[platillo])_tpvCart[platillo]=0;_tpvCart[platillo]=Math.max(0,_tpvCart[platillo]+delta);if(_tpvCart[platillo]===0)delete _tpvCart[platillo];render()}
async function submitTPV(){var platillos=getPlatillos();var entries=Object.entries(_tpvCart).filter(function(e){return e[1]>0});if(!entries.length)return;var n=now();var ok=0;var detalles=[];var descuentos=[];for(var e of entries){var nombre=e[0];var qty=e[1];var p=platillos[nombre];if(!p)continue;var id=nextId('V',S.ventas);try{await Sheets.append('\u{1F4B0} Ventas',[id,n.date,'TPV',nombre,qty,uName(),'[TPV]']);ok++;detalles.push(qty+'x '+nombre);for(var ing of p.ingredientes){descuentos.push({cat:ing.unidad||'',prod:ing.producto,qty:ing.cantidad*qty})}}catch(e2){toast('Error en '+nombre,1)}}var descGrouped={};descuentos.forEach(function(d){if(!descGrouped[d.prod])descGrouped[d.prod]={prod:d.prod,qty:0};descGrouped[d.prod].qty+=d.qty});var descList=Object.values(descGrouped);for(var d of descList){var id2=nextId('V',S.ventas);var cat=S.catalogo.find(function(c){return c.producto.trim().toLowerCase()===d.prod.trim().toLowerCase()});try{await Sheets.append('\u{1F4B0} Ventas',[id2,n.date,cat?.categoria||'',d.prod,Math.ceil(d.qty),uName(),'Descuento TPV'])}catch(e3){}}if(ok>0){await logAction('Venta TPV',detalles.join(', ')+' \u2192 Descuento: '+descList.map(function(d){return Math.ceil(d.qty)+' '+d.prod}).join(', '),'venta');toast('\u2705 '+ok+' platillo'+(ok>1?'s':'')+' registrados');_tpvCart={};Sheets.loadAll()}}
// === RECETAS ===
var _recetaIngredientes=[];
var _editRecetaNombre='';
function renderVentRecetas(){var platillos=getPlatillos();var keys=Object.keys(platillos).sort();var q=S.searchQuery.toLowerCase();if(q)keys=keys.filter(function(k){return k.toLowerCase().includes(q)});return(isAdmin()?'<button class="btn btn-primary" onclick="openModal(\'receta\')" style="width:100%;margin-bottom:12px">\u2795 Nueva Receta</button>':'')+'<div class="search-bar"><span>\u{1F50D}</span><input placeholder="Buscar receta..." value="'+S.searchQuery+'" oninput="S.searchQuery=this.value;render()"></div>'+(keys.length===0?'<div class="empty-state"><div class="empty-icon">\u{1F4D6}</div><p>Sin recetas</p></div>':keys.map(function(k){var p=platillos[k];return'<div class="card" style="margin-bottom:10px"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><div><div style="font-size:15px;font-weight:700">\u{1F37D}\ufe0f '+k+'</div><div style="font-size:11px;color:var(--text2)">'+p.categoria+'</div></div>'+(isAdmin()?'<div style="display:flex;gap:6px"><button class="btn btn-sm" style="padding:6px 10px;font-size:11px" onclick="editReceta(\''+k.replace(/'/g,"\\'")+'\')">\ufe0f</button><button class="btn btn-sm" style="padding:6px 10px;font-size:11px;color:var(--red)" onclick="deleteReceta(\''+k.replace(/'/g,"\\'")+'\')">\ufe0f</button></div>':'')+'</div>'+p.ingredientes.map(function(i){return'<div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid rgba(255,255,255,.04);font-size:13px"><span>\u{1F4E6} '+i.producto+'</span><span style="font-family:Space Mono;font-weight:600;color:var(--accent)">'+i.cantidad+(i.unidad?' '+i.unidad:'')+'</span></div>'}).join('')+'</div>'}).join(''))}
function fmReceta(){var cats=[...new Set(S.recetas.map(function(r){return r.categoria}))].filter(Boolean).sort();var prods=S.catalogo.map(function(p){return p.producto}).sort();return'<div class="modal-title">\u2795 Nueva Receta</div><div class="form-group"><label class="form-label">Nombre del Platillo (como sale en TPV)</label><input class="form-input" id="fRN" placeholder="Ej: Chapata de Pollo"></div><div class="form-group"><label class="form-label">Categor\u00eda</label><select class="form-select" id="fRC"><option value="">Seleccionar...</option>'+cats.map(function(c){return'<option value="'+c+'">'+c+'</option>'}).join('')+'<option value="__new__">\uff0b Nueva...</option></select></div><div id="newRecCatField" style="display:none"><div class="form-group"><label class="form-label">Nueva Categor\u00eda</label><input class="form-input" id="fRCN" placeholder="Ej: Chapatas"></div></div><div style="background:var(--surface2);border-radius:10px;padding:12px;margin-bottom:12px"><div style="font-size:13px;font-weight:700;margin-bottom:8px">\u{1F4E6} Ingredientes de Producci\u00f3n</div><div style="display:flex;gap:6px;margin-bottom:8px"><select class="form-select" id="fRI" style="flex:2;padding:8px;font-size:12px"><option value="">Producto...</option>'+prods.map(function(p){return'<option value="'+p+'">'+p+'</option>'}).join('')+'</select><input class="form-input" id="fRIQ" type="number" inputmode="decimal" placeholder="Cant" min="0.1" step="0.1" style="flex:1;padding:8px;font-size:12px"><button class="btn btn-sm" onclick="addRecIng()" style="padding:8px 12px">\u2795</button></div><div id="recIngList">'+renderRecIng()+'</div></div><button class="btn btn-success" onclick="submitReceta()" style="width:100%">\u2705 Guardar Receta</button><div style="height:10px"></div><button class="btn btn-secondary" onclick="_recetaIngredientes=[];closeModal()" style="width:100%">\u2716 Cerrar</button>';setTimeout(function(){var sel=document.getElementById('fRC');if(sel)sel.onchange=function(){document.getElementById('newRecCatField').style.display=this.value==='__new__'?'block':'none'}},100)}
function fmEditReceta(){var platillos=getPlatillos();var p=platillos[_editRecetaNombre];if(!p)return'<div class="modal-title">Error</div>';var cats=[...new Set(S.recetas.map(function(r){return r.categoria}))].filter(Boolean).sort();var prods=S.catalogo.map(function(p2){return p2.producto}).sort();_recetaIngredientes=p.ingredientes.map(function(i){return{producto:i.producto,cantidad:i.cantidad}});return'<div class="modal-title">\u270f\ufe0f Editar: '+_editRecetaNombre+'</div><div class="form-group"><label class="form-label">Nombre del Platillo</label><input class="form-input" id="fRN" value="'+_editRecetaNombre+'"></div><div class="form-group"><label class="form-label">Categor\u00eda</label><select class="form-select" id="fRC"><option value="">Seleccionar...</option>'+cats.map(function(c){return'<option value="'+c+'"'+(c===p.categoria?' selected':'')+'>'+c+'</option>'}).join('')+'<option value="__new__">\uff0b Nueva...</option></select></div><div id="newRecCatField" style="display:none"><div class="form-group"><label class="form-label">Nueva Categor\u00eda</label><input class="form-input" id="fRCN"></div></div><div style="background:var(--surface2);border-radius:10px;padding:12px;margin-bottom:12px"><div style="font-size:13px;font-weight:700;margin-bottom:8px">\u{1F4E6} Ingredientes</div><div style="display:flex;gap:6px;margin-bottom:8px"><select class="form-select" id="fRI" style="flex:2;padding:8px;font-size:12px"><option value="">Producto...</option>'+prods.map(function(p2){return'<option value="'+p2+'">'+p2+'</option>'}).join('')+'</select><input class="form-input" id="fRIQ" type="number" inputmode="decimal" placeholder="Cant" min="0.1" step="0.1" style="flex:1;padding:8px;font-size:12px"><button class="btn btn-sm" onclick="addRecIng()" style="padding:8px 12px">\u2795</button></div><div id="recIngList">'+renderRecIng()+'</div></div><button class="btn btn-success" onclick="submitEditReceta()" style="width:100%">\u2705 Guardar Cambios</button><div style="height:10px"></div><button class="btn btn-secondary" onclick="_recetaIngredientes=[];_editRecetaNombre=\'\';closeModal()" style="width:100%">\u2716 Cerrar</button>';setTimeout(function(){var sel=document.getElementById('fRC');if(sel)sel.onchange=function(){document.getElementById('newRecCatField').style.display=this.value==='__new__'?'block':'none'}},100)}
function addRecIng(){var prod=document.getElementById('fRI')?.value;var qty=parseFloat(document.getElementById('fRIQ')?.value)||0;if(!prod||qty<=0){toast('Selecciona producto y cantidad',1);return}var dup=_recetaIngredientes.find(function(i){return i.producto===prod});if(dup){dup.cantidad+=qty}else{_recetaIngredientes.push({producto:prod,cantidad:qty})}document.getElementById('fRI').selectedIndex=0;document.getElementById('fRIQ').value='';document.getElementById('recIngList').innerHTML=renderRecIng()}
function removeRecIng(idx){_recetaIngredientes.splice(idx,1);document.getElementById('recIngList').innerHTML=renderRecIng()}
function renderRecIng(){if(!_recetaIngredientes.length)return'<div style="font-size:12px;color:var(--text2);text-align:center;padding:8px">Agrega ingredientes</div>';return _recetaIngredientes.map(function(i,idx){return'<div style="display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid rgba(255,255,255,.04)"><span style="flex:1;font-size:13px">'+i.producto+'</span><span style="font-family:Space Mono;font-weight:600;font-size:13px;color:var(--accent)">'+i.cantidad+'</span><button onclick="removeRecIng('+idx+')" style="background:none;border:none;color:var(--red);cursor:pointer;font-size:14px">\u2716</button></div>'}).join('')}
async function submitReceta(){var nombre=document.getElementById('fRN')?.value?.trim();var cat=document.getElementById('fRC')?.value;var nc=document.getElementById('fRCN')?.value?.trim()||'';if(cat==='__new__'){if(!nc){toast('Escribe categor\u00eda',1);return}cat=nc}if(!nombre||!cat){toast('Completa nombre y categor\u00eda',1);return}if(!_recetaIngredientes.length){toast('Agrega al menos un ingrediente',1);return}var ok=0;for(var i of _recetaIngredientes){try{await Sheets.append('\u{1F37D}\ufe0f Recetas',[nombre,cat,i.producto,i.cantidad,'']);ok++}catch(e){toast('Error',1)}}if(ok>0){await logAction('Receta creada',nombre+': '+_recetaIngredientes.map(function(i){return i.cantidad+' '+i.producto}).join(', '),'receta');toast('\u2705 Receta '+nombre+' guardada');_recetaIngredientes=[];closeModal();Sheets.loadAll()}}
function editReceta(nombre){_editRecetaNombre=nombre;openModal('editReceta')}
async function submitEditReceta(){var nombre=document.getElementById('fRN')?.value?.trim();var cat=document.getElementById('fRC')?.value;var nc=document.getElementById('fRCN')?.value?.trim()||'';if(cat==='__new__'){if(!nc){toast('Escribe categor\u00eda',1);return}cat=nc}if(!nombre||!cat||!_recetaIngredientes.length){toast('Completa todos los campos',1);return}var oldRows=[];S.recetas.forEach(function(r,i){if(r.platillo===_editRecetaNombre)oldRows.push(i)});for(var idx=oldRows.length-1;idx>=0;idx--){try{await Sheets.deleteRow('\u{1F37D}\ufe0f Recetas',oldRows[idx]+2)}catch(e){}}for(var i of _recetaIngredientes){try{await Sheets.append('\u{1F37D}\ufe0f Recetas',[nombre,cat,i.producto,i.cantidad,''])}catch(e){}}await logAction('Receta editada',nombre,'receta');toast('\u2705 '+nombre+' actualizada');_recetaIngredientes=[];_editRecetaNombre='';closeModal();Sheets.loadAll()}
async function deleteReceta(nombre){if(!confirm('\u00bfEliminar receta "'+nombre+'"?'))return;var rows=[];S.recetas.forEach(function(r,i){if(r.platillo===nombre)rows.push(i)});for(var idx=rows.length-1;idx>=0;idx--){try{await Sheets.deleteRow('\u{1F37D}\ufe0f Recetas',rows[idx]+2)}catch(e){}}await logAction('Receta eliminada',nombre,'receta');toast('Receta eliminada');Sheets.loadAll()}
async function submitCartVenta(){if(_cartVenta.length===0)return;const total=_cartVenta.length;const detalle=_cartVenta.map(c=>c.qty+' '+c.prod).join(', ');let ok=0;for(const c of _cartVenta){const id=nextId('V',S.ventas);try{await Sheets.append('\u{1F4B0} Ventas',[id,today(),c.cat,c.prod,c.qty,uName(),c.notas]);ok++}catch(e){toast('Error en '+c.prod,1)}}
_cartVenta=[];await logAction('Venta',detalle,'venta');toast(ok+'/'+total+' ventas guardadas');closeModal();Sheets.loadAll()}

async function subNewProd(){if(!isAdmin()){toast('Sin permisos',1);return}let cat=document.getElementById('fNPC').value;const nc=document.getElementById('fNCN')?.value?.trim()||'';const nm=document.getElementById('fNPN').value.trim();const mn=document.getElementById('fNPM').value||'0';const un=document.getElementById('fNPU').value;if(cat==='__new__'){if(!nc){toast('Escribe la categor\u00eda',1);return}cat=nc}if(!cat||!nm){toast('Completa categor\u00eda y nombre',1);return}if(isDup(nm,cat)){toast('Producto ya existe',1);return}const id=nextId('PROD',S.catalogo);try{await Sheets.append('\u{1F4E6} Cat\u00e1logo',[id,cat,nm,parseInt(mn),un,'SI']);await logAction('Producto agregado',nm+' en '+cat,'add');toast(nm+' agregado');document.getElementById('fNPN').value='';document.getElementById('fNPM').value='';document.getElementById('dupW').innerHTML='';await Sheets.loadAll();const cs=document.getElementById('fNPC');if(cs){const cats=getCats();cs.innerHTML='<option value="">Seleccionar...</option>'+cats.map(c=>`<option value="${c}">${c}</option>`).join('')+'<option value="__new__">\uff0b Nueva categor\u00eda...</option>';cs.value=cat}}catch(e){toast('Error al guardar',1)}}

function saveSett(){S.sheetId=document.getElementById('sS').value;S.apiKey=document.getElementById('sA').value;localStorage.setItem('sheetId',S.sheetId);localStorage.setItem('apiKey',S.apiKey);toast('Guardado');closeModal();Sheets.loadAll()}
function resetApp(){localStorage.clear();S.sheetId='';S.apiKey='';S.screen='setup';S.setupStep=1;S.connected=false;S.currentUser=null;closeModal();render()}

(async function(){if(S.sheetId&&S.apiKey){const su=localStorage.getItem('currentUser');if(su){try{S.currentUser=JSON.parse(su);S.screen='main';S.connected=true;render();await Sheets.loadUsers();const ok=S.usuarios.find(u=>u.usuario===S.currentUser.usuario);if(!ok){toast('Cuenta deshabilitada',1);logout();return}await Sheets.loadAll()}catch(e){S.screen='login';render()}}else{S.screen='login';S.connected=true;await Sheets.loadUsers();render()}}else{render()}})();
</script>
</body>
</html>